{% extends "rundb/plan/page_plan/base.html" %}
{% load url from future %}

{% block main-title %}Select instrument, chip and kits and then hit next.{% endblock main-title %}

{% block page-plan-content %}
<div class="row-fluid bordered-section">
    <div class="span6">                                     
        <label class="form-label">Instrument</label>
        <select id="instrumentType">
            {% if helper.isEditRun %}
                {% if step.getPrePopulatedFieldDict.chipTypes %}
                    {% with step.getPrePopulatedFieldDict.chipTypes.0 as chipType %}
                    <option SELECTED value="{{chipType.instrumentType}}">
                        Ion  {{chipType.get_instrumentType_display}}&trade; System
                    </option>
                    {% endwith %}
                {% endif %}
            {% else %}
                <option value=""></option>
                {% for value, display in step.getPrePopulatedFieldDict.instrumentTypes %}
                    <option value="{{value}}">Ion  {{display}}&trade; System</option>
                {% endfor %}
            {% endif %}
        </select>
    </div>

    <div class="span6">                                     
        <label class="form-label">Chip Type{%if step.prepopulatedFields.is_chipType_required%} (required){%endif%}</label>
        <select id="chipType" name="chipType">
            {% if helper.isEditRun %}
                <option SELECTED value="{{step.getCurrentSavedFieldDict.chipType}}">Ion 
                {% if step.getPrePopulatedFieldDict.chipTypes %}
                    {% with step.getPrePopulatedFieldDict.chipTypes.0 as chipType %}
                        {{chipType.getChipDisplayedNamePrimaryPrefix}}&trade;{{chipType.getChipDisplayedNameSecondaryPrefix}} Chip {{chipType.getChipDisplayedVersion}}
                    {% endwith %}
                {% else %}
                    {{step.getCurrentSavedFieldDict.chipType }}&trade; Chip
                {% endif %}
                </option>
            {% else %}
                <option value=""></option>
                {% for chipType in step.getPrePopulatedFieldDict.chipTypes %}
                    {% if chipType.name == step.getCurrentSavedFieldDict.chipType %}
                        <option SELECTED 
                    {% elif not step.getCurrentSavedFieldDict.chipType and not helper.isTemplate and chipType.name == helper.getStepDict.Application.savedObjects.applProduct.defaultChipType %}
                        <option SELECTED 
                    {% else %}                    
                        <option 
                    {% endif %}
                    value="{{chipType.name}}">Ion {{chipType.getChipDisplayedNamePrimaryPrefix}}&trade;{{chipType.getChipDisplayedNameSecondaryPrefix}} Chip {{chipType.getChipDisplayedVersion}}</option>
                {% endfor %}
            {% endif %}
        </select>
    </div>
    <hr class="summary">  
</div>
<div class="row-fluid" style="margin-top: 20px">
    <div class="span6">
        <input type="hidden" id="isBarcodeKitRequired" name="isBarcodeKitRequired" value="" />

        <label class="form-label">Sample Preparation Kit (optional)</label>
        <select id="samplePreparationKit" name="samplePreparationKit" style="width: 350px;" {% if not helper.getApplProduct.isSamplePrepKitSupported %} disabled="disabled" {% endif %}>
            <option value=""></option>
            {% for spk in step.getPrePopulatedFieldDict.samplePrepKits %}
                {% ifequal spk.name step.getCurrentSavedFieldDict.samplePreparationKit %}
                    <option SELECTED value="{{spk.name}}">{{spk.description}}</option>
                {% else %}
                    <option value="{{spk.name}}">{{spk.description}}</option>
                {% endifequal %}
            {% endfor %}
        </select>
    </div>
    <div class="span6">
        <label class="form-label">Control Sequence (optional)</label>
        <select id="controlsequence" name="controlsequence" {% if step.getPrePopulatedFieldDict.controlSeqKits|length == 0 %} disabled {% endif %}>
            <option value=""></option>
            {% for kit in step.getPrePopulatedFieldDict.controlSeqKits %}
                {% ifequal kit.name step.getCurrentSavedFieldDict.controlsequence %}
                    <option SELECTED value="{{kit.name}}">{{kit.description}}</option>
                {% else %}
                    <option value="{{kit.name}}">{{kit.description}}</option>
                {% endifequal %}
            {% endfor %}
        </select>
    </div>
</div>
<div class="row-fluid">
    <div class="span6">
        <label class="form-label">Library Kit Type  <a class="btn btn-mini extra-kit-inline">Details +</a></label>
        <select id="libraryKitType" name="librarykitname" style="width: 350px;">
            <option value=""></option>
            {% for libKit in step.getPrePopulatedFieldDict.libKits %}
                {% ifequal libKit.name step.getCurrentSavedFieldDict.librarykitname %}
                    <option SELECTED value="{{libKit.name}}">{{libKit.description}}</option>
                {% else %}
                    <option value="{{libKit.name}}">{{libKit.description}}</option>
                {% endifequal %}
            {% endfor %}
        </select>
    </div>
    <div class="span6">                                     
        <label class="form-label" id="barcodeKitLabel">Barcode Set {% if helper.getApplProduct.isBarcodeKitSelectionRequired %}(required){% else %}(optional){% endif %}</label>
        <select id="barcodeId" name="barcodeId" {% if helper.isPlanBySample and step.getCurrentSavedFieldDict.barcodeId %}disabled="disabled"{% endif %}>
            <option value=""></option>
            {% for kit in step.getPrePopulatedFieldDict.barcodes %}
                {% ifequal kit.name step.getCurrentSavedFieldDict.barcodeId %}
                    <option SELECTED 
                {% else %}
                    <option 
                {% endifequal %}
                value="{{kit.name}}">{{kit.name}}</option>
            {% endfor %}
        </select>
    </div>
</div>                  
<div class="extra_kit_forward_info row-fluid hide" style="display: block;">
    <div class="span6">
        <label>Forward Library Key:</label>
        <select id="libraryKey" name="libraryKey" value="" class="select-group"  style="width:350px;">
            <option value=""></option>
            {% for libKey in step.getPrePopulatedFieldDict.forwardLibKeys %}
                {% ifequal libKey.sequence step.getCurrentSavedFieldDict.libraryKey %}
                    <option SELECTED value="{{libKey.sequence}}">{{libKey}}</option>
                {% else %}
                    <option value="{{libKey.sequence}}">{{libKey}}</option>
                {% endifequal %}
            {% endfor %}
        </select>
        <label>Test Fragment Key:</label>
        <input type="text" name="tfKey" value={{step.getCurrentSavedFieldDict.tfKey}}
               onkeyup="if('atcgATCG'.indexOf(this.value.slice(-1))<0) alert('Invalid TF key character');">
    </div>
    <div class="span6">                                     
        <label>Forward 3' Adapter:</label>
        <select id="forward3primeAdapter" name="forward3primeAdapter" value="" class="select-group">
            <option value=""></option>
            {% for adapter in step.getPrePopulatedFieldDict.forward3Adapters %}
                {% ifequal adapter.sequence step.getCurrentSavedFieldDict.forward3primeAdapter %}
                    <option SELECTED value="{{adapter.sequence}}">{{adapter}}</option>
                {% else %}
                    <option value="{{adapter.sequence}}">{{adapter}}</option>
                {% endifequal %}
            {% endfor %}
        </select>
    </div>
    <div class="span6 hideIfPgm" style="...">
        <label>Flow Order:</label>
        <select id="flowOrder" name="flowOrder" value="" class="select-group">
            {% if helper.isEditRun %}
                <option SELECTED value="{{step.getCurrentSavedFieldDict.flowOrder}}">
                    {{step.getCurrentSavedFieldDict.flowOrder}}
                </option>
            {% else %}
                <option value=""></option>
                {% for flowOrder in step.getPrePopulatedFieldDict.flowOrders %}
                    {% ifequal flowOrder.flowOrder step.getCurrentSavedFieldDict.flowOrder %}
                        <option SELECTED value="{{flowOrder.flowOrder}}">{{flowOrder.description}}</option>
                    {% else %}
                        <option value="{{flowOrder.flowOrder}}">{{flowOrder.description}}</option>
                    {% endifequal %}
                {% endfor %}
            {% endif %}
        </select>
    </div>
</div>                      
<div class="row-fluid">
    <div class="span6">
        <p class="form-label">Template Kit
        <span class="option-group">
        <small style="font-weight: normal; font-size: 75%;">
            {% for kitTypeName, kitDict in step.getPrePopulatedFieldDict.templateKitTypes.items %}
                {% ifequal kitTypeName "Avalanche" %}
                {% else %}
                <input type="radio" id="{{kitTypeName}}__templatekitType" name="templatekitType" value="{{kitTypeName}}"
                    {% if kitTypeName == step.getCurrentSavedFieldDict.templatekitType and step.getCurrentSavedFieldDict.templatekitname %}
                                    checked="checked" data-templatekitname="{{step.getCurrentSavedFieldDict.templatekitname}}"
                    {% endif %}
                >{{kitTypeName}}
                {% endifequal %}
            {% endfor %}
        </p>      
        </small>
        </span>
        
        <div id="templateKitHolder">
            {% if not step.getCurrentSavedFieldDict.templatekitType %}
                <input id="templateKit_comment" name="templateKit_comment" type="text" placeholder="Choose instrument to view Template Kit menu" style="width: 335px" disabled>
            {% endif %}
            
            <select id="templateKit" name="templatekitname" style="width: 350px;" {% if not step.getCurrentSavedFieldDict.templatekitType %} class="hide" {% endif %}>
                <option value=""></option>
                {% for kitTypeName, kitDict in step.getPrePopulatedFieldDict.templateKitTypes.items %}
                    {% for kit in kitDict.kit_values %}
                        <option value="{{kit.name}}" class="{{kitTypeName}}"
                            {% if kit.name == step.getCurrentSavedFieldDict.templatekitname %}
                                SELECTED
                            {% elif kit.name == kitDict.applDefault.name and not step.getCurrentSavedFieldDict.templatekitname %}
                                SELECTED
                            {% endif %}
                                >{{kit.description}}</option>
                    {% endfor %}
                {% endfor %}
            </select>
            
        </div>
    </div>
</div>

<div class="templating_size_info row-fluid hide" style="display: block;">
    <div class="span6">
        <p style="font-weight: bold; font-size: 14px; margin-bottom: 8px;">Templating Size:
        <span class="option-group">
            <small style="font-weight: normal; font-size: 100%;">
                {% for size in step.getPrePopulatedFieldDict.templatingSizeChoices %}
                    <label style="display: inline;">
                        <input type="radio" id="templatingSize_{{size}}" name="templatingSize" value="{{size}}" {% if helper.isEditRun %} readonly {% endif %}
                            {% ifequal size step.getCurrentSavedFieldDict.templatingSize %} checked="checked" {% endifequal %}\>{{size}}
                    </label>
                {% endfor %}
            </small>
        </span>
        </p>
    </div>
    <div class="span6">
    </div>
</div>        

<div class="library_read_length_info row-fluid hide" style="display: block;">
    <div class="span6">
        <p style="font-weight: bold; font-size: 14px; margin-bottom: 12px;">Library Read Length:
        <input value="{{step.getCurrentSavedFieldDict.libraryReadLength}}" style="width:50px; font-weight: normal; font-size: 14px;" name="libraryReadLength" id="libraryReadLength" {% if helper.isEditRun %} readonly {% endif %}>
        </p>
    </div>
    <div class="span6">
    </div>
</div>
<div class="read_length_info row-fluid hide" style="display: block;">
    <div class="span6">
        <p style="font-weight: bold; font-size: 14px; margin-bottom: 8px;">Read Length:
        <span class="option-group">
            <small style="font-weight: normal; font-size: 100%;">
                {% for readLength in step.getPrePopulatedFieldDict.readLengthChoices %}
                    <label style="display: inline;">
                        <input type="radio" id="readLength_{{readLength}}" name="readLength" value="{{readLength}}" {% if helper.isEditRun %} readonly {% endif %}
                            {% if readLength|stringformat:"s"  == step.getCurrentSavedFieldDict.libraryReadLength|stringformat:"s"  or readLength|stringformat:"s"  == step.getCurrentSavedFieldDict.readLength|stringformat:"s"   %} checked="checked" {% endif  %}\>{{readLength}}
                    </label>
                {% endfor %}
            </small>
        </span>
        </p>
    </div>
    <div class="span6">
    </div>
</div>

<div class="row-fluid">
    <div class="span6">
        <label class="form-label" >Sequencing Kit</label>
        <select id="sequenceKit" name="sequencekitname" style="width: 350px;">
            <option value=""></option>
            {% for kit in step.getPrePopulatedFieldDict.seqKits %}
                {% ifequal kit.name step.getCurrentSavedFieldDict.sequencekitname %}
                    <option SELECTED value="{{kit.name}}">{{kit.description}}</option>
                {% else %}
                    <option value="{{kit.name}}">{{kit.description}}</option>
                {% endifequal %}
            {% endfor %}
        </select>
    </div>
    <div class="span6">
        <label class="form-label" >Flows</label>
        <input value="{{step.getCurrentSavedFieldDict.flows}}" style="width:50px; font-weight: normal; font-size: 14px;" name="flows" id="flows" {% if helper.isEditRun %} readonly {% endif %}>
    </div>

</div>

<div class="row-fluid">
    <div class="span6">
        <p class="form-label" rel="tooltip" title="Base Calibration allows for empirical alignments to influence flow signals to achieve better homopolymer calibration to improve overall accuracy">
        <i class="icon-info-sign"></i> Base Calibration Mode</p>
        <select id="base_recalibrate" name="base_recalibrate" style="width: 220px;">
        <!--option value=""></option -->

        {% for mode, displayedMode in step.getPrePopulatedFieldDict.base_recalibration_modes.items %}
            {% ifequal mode step.getCurrentSavedFieldDict.base_recalibrate %}
                <option SELECTED value="{{mode}}">{{displayedMode}}</option>
            {% else %}
                <option value="{{mode}}">{{displayedMode}}</option>
            {% endifequal %}
        {% endfor %}
        </select>
    </div>
    
    <div class="span6">
        <p class="form-label" rel="tooltip" title="PCR duplicates will be flagged in the BAM file"><i class="icon-info-sign"></i> Mark as Duplicates Reads 
            <input type="checkbox" id="isDuplicateReads" name="isDuplicateReads" 
                {% if step.getCurrentSavedFieldDict.isDuplicateReads %}checked="checked"{% endif %} style="vertical-align:top;">
            
        </p>    
        <p class="form-label" rel="tooltip" title="Optional analysis step to adjust the alignment, primarily in the CIGAR string"><i class="icon-info-sign"></i> Enable Realignment
            <input type="checkbox" id="realign" name="realign" {% if step.getCurrentSavedFieldDict.realign %}checked="checked"{% endif %} style="vertical-align:top;">           
        </p>
    </div>
</div>

<div class="row-fluid">
    {% for key, value in step.validationErrors.items %}
        <h4 style="color: red">{{value}}</h4>
    {% endfor %}
</div>
{% endblock page-plan-content %}

{% block prevnext-buttons %}
    <a class="btn btn-100" href="#" onclick="$('#step_form').attr('action', '{% url "page_plan_application" %}');$('#step_form').submit();return false;">&larr; Previous</a>
    <a class="btn btn-primary btn-100 pull-right" href="#" onclick="$('#step_form').attr('action', '{% url "page_plan_plugins" %}');$('#step_form').submit();return false;">Next &rarr;</a>
    
{% endblock prevnext-buttons %}

{% block summary-table %}
    {%include "rundb/plan/page_plan/summary/kit_summary.html"%}
{% endblock summary-table %}

{% block post-raw %}
{{ block.super }}
<script type="text/javascript">
    // Populate info needed for smart filtering
    function applicationType_to_values(applicationType){
        if (applicationType == 'AMPS_ANY')
            return "AMPS;AMPS_DNA_RNA;AMPS_EXOME;AMPS_RNA"
        return applicationType
    }
    function samplePrep_instrumentType_to_values(samplePrep_instrumentType){
        if (samplePrep_instrumentType == "OT_IC")
            return "OT;IC";
        return samplePrep_instrumentType;
    }
    
    var sequencingKits = {};
    var categories_to_seq_kits_map = {};
    {% for kit in step.getPrePopulatedFieldDict.seqKits %}
        sequencingKits["{{kit.name}}"] = {
            "index":       {{forloop.counter0}},
            "value":       "{{kit.name}}",
            "display":     "{{kit.description}}",
            "runType": applicationType_to_values("{{kit.applicationType}}"),
            "categories":  "{{kit.categories}}" || "",
            "chipTypes":   "{{kit.chipTypes}}",
            "flowCount":   "{{kit.flowCount}}",
            "seq_instruments":  "{{kit.instrumentType}}",
            "samplePrep_instruments":  samplePrep_instrumentType_to_values("{{kit.samplePrep_instrumentType}}")
        };
        {% if kit.categories %}
            categories_to_seq_kits_map["{{kit.categories | lower}}"] = "{{kit.name}}";
        {% endif %}
    {% endfor %}

    var templateKits = {};
    {% for kit in step.getPrePopulatedFieldDict.templateKits %}
        templateKits["{{kit.name}}"] = {
            "index":       {{forloop.counter0}},
            "value":       "{{kit.name}}",
            "display":     "{{kit.description}}",
            "runType": applicationType_to_values("{{kit.applicationType}}"),
            "categories":  "{{kit.categories}}" || "",
            "chipTypes":   "{{kit.chipTypes}}",
            "flowCount":   "{{kit.flowCount}}",
            "seq_instruments":  "{{kit.instrumentType}}",
            "samplePrep_instruments":  samplePrep_instrumentType_to_values("{{kit.samplePrep_instrumentType}}"),
            "libraryReadLength":"{{kit.libraryReadLength}}",
            "templatingSize":   "{{kit.templatingSize}}"
        };
    {% endfor %}

    var libraryKits = {};
    {% for kit in step.getPrePopulatedFieldDict.libKits %}
        libraryKits["{{kit.name}}"] = {
            "index":       {{forloop.counter0}},
            "value":       "{{kit.name}}",
            "display":     "{{kit.description}}",
            "runType": applicationType_to_values("{{kit.applicationType}}"),
            "categories":  "{{kit.categories}}" || "",
            "seq_instruments":  "{{kit.instrumentType}}"
        };
    {% endfor %}

    var chips = {};
    {% for chip in step.getPrePopulatedFieldDict.chipTypes %}
        chips["{{chip.name}}"] = {
            "index": {{forloop.counter0}},
            "value": "{{chip.name}}",
            "display": "Ion " + "{{chip.getChipDisplayedNamePrimaryPrefix}}" + "&trade;" +
                "{{chip.getChipDisplayedNameSecondaryPrefix}}" + " Chip " + "{{chip.getChipDisplayedVersion}}",
            "seq_instrument": "{{chip.instrumentType}}"
        };
    {% endfor %}

    var defaultFlowsFromCategoryRules = {{step.getPrePopulatedFieldDict.defaultFlowsFromCategoryRules|safe}};
    
    var applProductDefaults = {};
    {% for applProduct in helper.getStepDict.Application.getPrePopulatedFieldDict.applProducts %}
        var defaultTemplateKit = '{{applProduct.defaultTemplateKit.name}}' || '';
        var defaultIonChefPrepKit = '{{applProduct.defaultIonChefPrepKit.name}}' || '';

        var defaultTemplateKitType = '';
        if (defaultTemplateKit && !defaultIonChefPrepKit){
            defaultTemplateKitType = "OneTouch";
        } else if (defaultIonChefPrepKit && !defaultTemplateKit){
            defaultTemplateKitType = "IonChef";
        }

        applProductDefaults['{{applProduct}}'] = {
            "defaultTemplateKitType": defaultTemplateKitType,
            "defaultTemplateKit": defaultTemplateKit,
            "defaultIonChefPrepKit": defaultIonChefPrepKit,
            "defaultLibraryKit": '{{applProduct.defaultLibraryKit.name}}' || '',
            "defaultSequencingKit": '{{applProduct.defaultSequencingKit.name}}' || ''
        }
    {% endfor %}
    
    $(document).ready(function () {

        $("form").submit(function(){
            $("select[name=barcodeId]").attr('disabled', false);
        });

        $("#base_recalibrate").each( function (){
            var i =0;
            var sel = this;
            for(i = 0; i < sel.length;i++){
                if (sel.options[i].text == "Default Calibration") {
                    sel.options[i].title = "A random sample of reads (up to 100,000 by default) is aligned and used to determine calibration parameters, which are then applied to the rest of the run";
                }
                else if (sel.options[i].text == "Enable Calibration Standard") {
                    sel.options[i].title = "Select Enable Calibration Standard when the experiment does not include a reference BAM file.  Only choose this option if you have added Calibration Standards with the library for AmpMix preparation.";
                }
            }
           } 
        );
        
        var _isEditRun = "{{helper.isEditRun}}" == "True" ? true : false;

        var barcode_kits_subset_list = [];
        
        {% for barcodeKit in step.getPrePopulatedFieldDict.barcodes_subset %}
            barcode_kits_subset_list.push("{{barcodeKit.name}}");
        {% endfor %}
        
        var barcode_kits_all_list = [];
        
        {% for barcodeKit in step.getPrePopulatedFieldDict.barcodes %}
            barcode_kits_all_list.push("{{barcodeKit.name}}");
        {% endfor %}
        

        function init_templatingSize_n_readLength_visibility() { 
            var templateKit = templateKits[$("#templateKit").val()];
            if (templateKit) {
                var categories = templateKit.categories;
                
                if (categories.toLowerCase().indexOf("multiplereadlength") >= 0) {
                    $('.templating_size_info').hide();
                    $('.library_read_length_info').hide();
                    $('.read_length_info').show();   
                }
                else if (categories.toLowerCase().indexOf("supportlibraryreadlength") >= 0) {
                    $('.library_read_length_info').show();
                    $('.read_length_info').hide();                   
                }
                else {
                    $('.templating_size_info').hide();
                    $('.library_read_length_info').hide();
                    $('.read_length_info').hide();
               }
            }
        }
          
        function handleTemplateKitSelectionForTemplatingSize() {
            $('input[name = "templatingSize"]').prop('checked', false);                    
            $('.templating_size_info').hide();
            
            var defaultTemplatingSize = "";
            var templateKit = templateKits[$("#templateKit").val()];
            
            if (templateKit) {
                var categories = templateKit.categories;
                if (categories.toLowerCase().indexOf("multiplereadlength") >= 0) {
                    $('.templating_size_info').hide();
                    $('.library_read_length_info').hide();
                }
                if (categories.toLowerCase().indexOf("multipletemplatingsize") >= 0) {
                    var allowed_templatingSizes = templateKit.templatingSize;
                    //console.log("at handleTemplateKitSelectionForTemplatingSize() categories=", categories, "; allowed_templatingSizes=", allowed_templatingSizes);
                    if (allowed_templatingSizes) {
                        $('input[name = "templatingSize"]').parent().hide();

                        jQuery.each(allowed_templatingSizes.split(";"), function(index, item) {
                            $('input[name = "templatingSize"][value="' + item + '"]').parent().show();
                            if (index == 0) {
                                $('input[name = "templatingSize"][value="' + item + '"]').prop('checked', true);
                                defaultTemplatingSize = item;
                            }
                        });
                        $('.templating_size_info').show(); 
                    }
                }
            }
            updateSummaryPanel("#selectedTemplatingSize", defaultTemplatingSize);
        }

        function handleTemplateKitSelectionForLibraryReadLength() {
            $('.library_read_length_info').hide();
            var templateKit = templateKits[$("#templateKit").val()];

            if (templateKit && templateKit.categories.toLowerCase().indexOf("supportlibraryreadlength") >= 0) {
                updateLibraryReadLength();
                $('.library_read_length_info').show();
            }
        }


        function updateLibraryReadLength(){
            var defaultLibraryReadLength = 0;
            var templateKit = templateKits[$("#templateKit").val()];

            if (templateKit && templateKit.categories.toLowerCase().indexOf("supportlibraryreadlength") >= 0) {
                defaultLibraryReadLength = templateKit.libraryReadLength;

                var sequenceKit = sequencingKits[$("#sequenceKit").val()];
                if (sequenceKit && sequenceKit.categories.toLowerCase().indexOf("readlengthderivablefromflows") >= 0){
                    // set Library Read Length from Seq Kit flows instead
                    var seqKitFlowCount = sequenceKit.flowCount;
                    if (seqKitFlowCount > 0) defaultLibraryReadLength = seqKitFlowCount / 2.2 | 0;
                } else {
                    setFlowCountByLibraryReadLength(defaultLibraryReadLength);
                }
            }
            $('input[name = "libraryReadLength"]').val(defaultLibraryReadLength);
            updateSummaryPanel("#selectedLibraryReadLength", $('input[name = "libraryReadLength"]').val());
        }


        //for some templating kits, templating size cannot be used to drive UI behavior or db persistence.  Need to use read length instead
        function handleTemplateKitSelectionForReadLength() {
            $('input[name = "readLength"]').prop('checked', false);     
            $('.read_length_info').hide();
            
            var defaultReadLength = "";
            var templateKit = templateKits[$("#templateKit").val()];
            
            if (templateKit) {
                var categories = templateKit.categories;
                
                if (categories.toLowerCase().indexOf("multiplereadlength") >= 0) {
                    // use TemplatingSize field to define available Read length radio buttons
                    var allowed_readLengths = templateKit.templatingSize;
                    if (allowed_readLengths) {
                        $('input[name = "readLength"]').parent().hide();

                        jQuery.each(allowed_readLengths.split(";"), function(index, item) {
                            $('input[name = "readLength"][value="' + item + '"]').parent().show();
                            if (index == 0) {
                                $('input[name = "readLength"][value="' + item + '"]').prop('checked', true);
                                defaultReadLength = item;
                            }
                        });
                        $('.read_length_info').show();
                        updateSummaryPanel("#selectedLibraryReadLength", defaultReadLength);
                    }
                }
            }
        }
    
        function handleTemplateKitSelectionForAutoSeqKitSelection() {
            var templateKit = templateKits[$("#templateKit").val()];

            if (templateKit) {
                var categories = templateKit.categories;
                var categories_lower = categories.toLowerCase();
                
                if (categories_lower.indexOf("s5") >= 0) {
                    //if sequencing kit's categories is same or is subset of templating kit's categories, we found our entry
                    $.each(categories_to_seq_kits_map , function(key, value) {
                        if (categories_lower.indexOf(key) >= 0) {
                            //alert( key + ": " + value );
                            seqKitName = value;
                            $("#sequenceKit").val(seqKitName);
                            handleSequencingKitSelection(seqKitName);
                        }
                    });
                }
            }
        }
        

        function handleSeqKitSelectionForFlowOrder(selectedSeqKitName) {
            var defaultFlowOrder = "";
            {% for kit in step.getPrePopulatedFieldDict.seqKits %}
                var seqKitName = "{{kit.name}}";
                if (seqKitName == selectedSeqKitName) {
                    if ("{{kit.defaultFlowOrder}}" != null) {
                        defaultFlowOrder = "{{kit.defaultFlowOrder.flowOrder}}";                    
                    }
                    else {
                        defaultFlowOrder = "";
                    }                    
                }
            {% endfor %}
             
            $('#flowOrder option[value="'+defaultFlowOrder+'"]').attr('selected', 'selected');
            $('#flowOrder').change();
        }


        function handleSequencingKitSelection(selectedSequenceKitName) {        
            if (!_isEditRun) {    
                setFlowCountBySelectedKits()
                updateLibraryReadLength();
                handleSeqKitSelectionForFlowOrder(selectedSequenceKitName);
            }

            updateSummaryPanel("#selectedSequenceKit", seqKitNameToDesc[selectedSequenceKitName]);
        }
        
        function updateSummaryPanel(el, value){
            if (typeof value == 'undefined') value = '';
            if (el=="#selectedLibraryReadLength" && value<=0) value = "--";
            $(el).html(value);
        }
        
        
        function updateFlows(value) {
            if (!_isEditRun && value > 0){
                $('input[name = "flows"]').val(value);
                updateSummaryPanel("#selectedFlows", value);
            }
        }

        function toggleFlowOrder() {
            if ($("#instrumentType").val() == "pgm"){
                $(".hideIfPgm").css('display','none');
                updateSummaryPanel("#selectedFlowOrder", "");
                $("#flowOrder").val("");
            }
            else{
                $(".hideIfPgm").show();
             }
        }

        function setFlowCountBySelectedKits(){
            
            if (_isEditRun) return;
            
            var templateKit = templateKits[$("#templateKit").val()];
            var sequenceKit = sequencingKits[$("#sequenceKit").val()];
            var templateKitFlowCount = templateKit ? templateKit.flowCount : 0;
            var sequenceKitFlowCount = sequenceKit ? sequenceKit.flowCount : 0;

            var flowCount = 0;
            if (!templateKit){
                flowCount = sequenceKitFlowCount;
            } else if (!sequenceKit){
                flowCount = templateKitFlowCount;
            } else {
                // both kits selected: use templateKit flows if flowoverridable, otherwise use sequenceKit flows
                var categories = sequenceKit.categories;
                if ((categories.toLowerCase().indexOf("flowoverridable") >= 0) && (templateKitFlowCount > 0)){
                    flowCount = templateKitFlowCount;
                } else {
                    flowCount = sequenceKitFlowCount;
                }
            }
            updateFlows(flowCount);
        }
        
        function setFlowCountByLibraryReadLength(libraryReadLength) {
            var sequenceKit = sequencingKits[$("#sequenceKit").val()];
            if (sequenceKit) {
                var categories = sequenceKit.categories;
                if (categories.toLowerCase().indexOf("flowsderivablefromreadlength") >= 0){
                    updateFlows((libraryReadLength * 2.2) | 0);
                }
            }
        }

        // Set number of flows based on category in selected Template Kit
        function set_default_flows_from_category_rules(){
            var templateKit = templateKits[$("#templateKit").val()];
            if (templateKit && templateKit.categories){
                var flowCount = null;
                // values_selected fields must correspond to rules defined in KitInfo._category_flowCount_rules
                var values_selected = {
                    'templatingSize': $('[name=templatingSize]:checked').val(),
                    'readLength': $('[name=readLength]:checked').val(),
                    'chipType': $('#chipType').val(),
                }

                $.each(defaultFlowsFromCategoryRules, function(i, rule){
                    if (templateKit.categories.toLowerCase().indexOf(rule.category.toLowerCase()) >= 0){
                        for (field in values_selected) {
                            if (field in rule && values_selected[field] == rule[field]){
                                flowCount = rule.flowCount;
                            }
                        }
                    }
                });
                if (flowCount) updateFlows(flowCount);
            }
        }

        function update_barcodeKit_dropdown() {
            $('#barcodeKitLabel').text("Barcode Set (optional)");
            $('input[name = "isBarcodeKitRequired"]').val("false");
            var value_list = barcode_kits_all_list;

            var libraryKit = libraryKits[$("#libraryKitType").val()];
            if (libraryKit){
                if (libraryKit.categories.toLowerCase().indexOf("bcrequired") >= 0) {
                    $('#barcodeKitLabel').text("Barcode Set (required)");
                    $('input[name = "isBarcodeKitRequired"]').val("true");
                }
                
                if (libraryKit.categories.toLowerCase().indexOf("bcshowsubset") >= 0)
                    value_list = barcode_kits_subset_list;
            }

            var $selects = $("#barcodeId");
            $selects.empty();
            $selects.append($("<option></option>"));
            
            //loop through the barcode kits
            $.each(value_list, function(i) {
                var value = value_list[i];
                
                var $opt = $("<option></option>");
                if (value == "{{step.getCurrentSavedFieldDict.barcodeId}}") {
                    $opt.attr("selected","selected");
                }                
                $opt.attr('value', value);
                $opt.text(value);
                $selects.append($opt);
            });
        }        

        function getApplProduct() {
            var selectedInstrumentType = $("#instrumentType").val();
            var applProduct = applProductToInstrumentType[selectedInstrumentType.toLowerCase()];
            console.log(">>> selectedInstrumentType=", selectedInstrumentType, "applProduct=", applProduct);
            return applProduct; 
        }
        
        function handleAutoSelectionByApplProduct(selectedInstrumentType) {
            //get the applProduct for selected instrumentType
            var applProduct = getApplProduct();
            if (!_isEditRun && applProduct) {
                var defaults = applProductDefaults[applProduct];

                if (defaults.defaultLibraryKit){
                    $('#libraryKitType option[value="'+defaults.defaultLibraryKit+'"]').attr('selected', 'selected');
                    $('#libraryKitType').change();
                }

                // select default Template Kit Type and trigger change to update Kit dropdown options and selected value
                var defaultTemplateKitType = defaults.defaultTemplateKitType || $('input[name="templatekitType"]:checked').val();
                $('input[name="templatekitType"][value='+ defaultTemplateKitType +']').prop('checked', true);
                $('input[name="templatekitType"][value='+ defaultTemplateKitType +']').change();

                if (defaults.defaultSequencingKit) {
                    $('#sequenceKit option[value="'+defaults.defaultSequencingKit+'"]').attr('selected', 'selected');
                    $('#sequenceKit').change();
                }
            }
        }


        $("#sequenceKit").on('change', function(){
            handleSequencingKitSelection($(this).val());
        });

        $("#samplePreparationKit").change(function()  {
            updateSummaryPanel("#selectedSamplePreparationKit", $(this).val());
        });


        $("#libraryKitType").change(function()  {
        	//update barcode kit selection list on library kit selection changed
        	var libKitName = $(this).val();
        	//console.log("at libraryKitType.change() libKitName=", libKitName);
            update_barcodeKit_dropdown()
            updateSummaryPanel("#selectedLibraryKitType", libKitNameToDesc[libKitName]);
        }).change();


        $('input[name="templatekitType"]').change(function () {
            $("#templateKit_comment").hide();
            $("#templateKit").show();

            // update dropdown options
            update_TemplateKit_select();
            update_SequencingKit_select()

            // retrieve previously selected kit or default if any
            var templateKit = $(this).data('templatekitname') || '';
            if (!templateKit || $("#templateKit option[value='"+ templateKit +"']").length == 0){
                var defaults = applProductDefaults[getApplProduct()];
                if (defaults){
                    templateKit = ($(this).val() == 'OneTouch') ? defaults.defaultTemplateKit : defaults.defaultIonChefPrepKit;
                }
            }
            $("#templateKit").val(templateKit).change();
        });


        $("#templateKit").change(function()  {

        	var selectedVal = $(this).find("option:selected").val();
        	
            // save kit value to restore if type selection changes
            if (selectedVal) $('input[name="templatekitType"]:checked').data('templatekitname', selectedVal);
            
            setFlowCountBySelectedKits();
            handleTemplateKitSelectionForTemplatingSize();
            handleTemplateKitSelectionForLibraryReadLength();
            handleTemplateKitSelectionForReadLength();
            handleTemplateKitSelectionForAutoSeqKitSelection();
            set_default_flows_from_category_rules();

            updateSummaryPanel("#selectedTemplatingKitName", templateKitNameToDesc[selectedVal]);
        });


        $("#libraryKey").change(function() {
            updateSummaryPanel("#selectedLibraryKey", libraryKeySeqToNameAndSeq[$(this).val()]);
        });
        

        $("#forward3primeAdapter").change(function() {
        	var value = $(this).val();

            if (value == "{{step.getCurrentSavedFieldDict.avalancheForward3PrimeAdapter}}") {
            	$('input[name="templatekitType"][value="OneTouch"]').attr('checked', true).change();
            }
            
            updateSummaryPanel("#selected3PrimeAdapter", threePrimeAdapterSeqToNameAndSeq[value]);
        });

        $("#flowOrder").change(function() {
            var value = $(this).val();

            var displayedValue = flowOrderToDescAndFlowOrder[value];
            if (displayedValue) {
                updateSummaryPanel("#selectedFlowOrder", displayedValue);
            }
            else {
                updateSummaryPanel("#selectedFlowOrder", "(use instrument settings)");
            }
        });
        
        var flowsSpinner = $("#flows").spinner({min: 1, max: 2000});
        flowsSpinner.spinner("value", '{{step.getCurrentSavedFieldDict.flows}}');
        if (_isEditRun){
            flowsSpinner.spinner("disable").prop('disabled',false);
        } else {
            $("#flows").on("spinstop spinchange", function(event, ui){
                updateSummaryPanel("#selectedFlows", flowsSpinner.spinner("value"));
            });
        }

    
        var readLengthSpinner = $("#libraryReadLength").spinner({min: 0, max: 1000});
        readLengthSpinner.spinner("value", '{{step.getCurrentSavedFieldDict.libraryReadLength}}');
        if (_isEditRun){
            readLengthSpinner.spinner("disable").prop('disabled',false);
        } else {
            $("#libraryReadLength").on("spinstop spinchange", function(event, ui){
                var value = readLengthSpinner.spinner("value");
                updateSummaryPanel("#selectedLibraryReadLength", value); 
                setFlowCountByLibraryReadLength(value);
            });
        }


        $('input[type=radio][name=templatingSize]').change(function() {
            updateSummaryPanel("#selectedTemplatingSize", this.value);

            // TS-10547 set number of flows based on templating size selection
            set_default_flows_from_category_rules();
        });

        $('input[type=radio][name=readLength]').change(function() {
            updateSummaryPanel("#selectedLibraryReadLength", this.value);

            // TS-11339,  TS-11340 set number of flows based on read length selection
            set_default_flows_from_category_rules();
        });

        $("#controlsequence").change(function()  {
            updateSummaryPanel("#selectedControlSequence", $(this).val());
        });     

        $("#chipType").change(function()  {
            if (!$('#instrumentType').val()){
                var chip = chips[$(this).val()];
                $('#instrumentType').val(chip ? chip['seq_instrument'] : "");
                $('#instrumentType').change();
            } else {
                update_LibraryKit_select();
                update_TemplateKit_select();
                update_SequencingKit_select();
            }
            set_default_flows_from_category_rules();
            updateSummaryPanel("#selectedChipType", chipNameToDisplayName[$(this).val()]);
        });

        $("#instrumentType").change(function()  {
            update_ChipType_select();
            update_LibraryKit_select();
            update_TemplateKit_select();
            update_SequencingKit_select();
            toggleFlowOrder();

            handleAutoSelectionByApplProduct($(this).val());
        });
        
        $("#barcodeId").change(function()  {
            updateSummaryPanel("#selectedBarcode", $(this).val());
        });
        
        $(".extra_kit_forward_info").hide();
        $(".extra-kit-inline").click(function() {
            if (($(".extra_kit_forward_info").is(":visible"))) {
                $(".extra-kit-inline").text("Details +");
                $(".extra_kit_forward_info").hide();
            } else {
                $(".extra-kit-inline").text("Details -");
                toggleFlowOrder();
                $(".extra_kit_forward_info").show();
            }
        });

        init_templatingSize_n_readLength_visibility();

        //hide templatingSize UI section by default if value is blank
        if ($('input[name = "templatingSize"]:checked').val() == undefined) {
            $(".templating_size_info").hide();
        }
        else {
            $(".templating_size_info").show();
        }

        $('#isDuplicateReads').change(function(){
            if($(this).is(':checked')) {
                $('#selectedMarkAsPcrDuplicates').text('True');
            } else {
                $('#selectedMarkAsPcrDuplicates').text('False');
            }
            
        });

        // generate filtered dropdowns
        if ($('#chipType').val()){
            var chip = chips[$('#chipType').val()];
            $('#instrumentType').val(chip ? chip['seq_instrument'] : "");
        }
        update_ChipType_select();
        update_LibraryKit_select();
        update_TemplateKit_select();
        update_SequencingKit_select();
    });

    // ******************* Filters ************************* //
    
    function filter_select_dropdown(data, filters, selectId){
        // re-create dropdown options after applying filters
        // filter logic is: value == filter OR !value
        // multiple values must use ";" as separator, e.g. "RNA;AMPS_RNA"
        var filtered_options = $.map(data, function(option){
            for (filterKey in filters){
                if (option[filterKey] && option[filterKey] != "None"){
                    var match_values = option[filterKey].split(';');
                    if (match_values.indexOf(filters[filterKey]) < 0){
                        //console.log('filtered', selectId, filters[filterKey], match_values, option.display)
                        return;
                    }
                }
            }
            return ({ "index": option.index, "value": option.value, "display": option.display });
        });
        // make sure to keep original option order
        filtered_options.sort(function(a,b){ return a.index > b.index? 1: -1;})

        // create dropdown options
        var $select = $(selectId);
        var selectedValue = $select.val();
        $select.empty();
        $select.append($("<option></option>"));

        $.each(filtered_options, function(i, obj){
            $select.append(
                $('<option>', {
                    value: obj.value,
                    html: obj.display,
                    selected: obj.value == selectedValue
                })
            );
        });
        // if previously selected option no longer available, trigger onchange
        if ($select.val() != selectedValue){
            console.log(selectId, selectedValue, 'not available after filtering');
            $select.change();
        }
    }

    function update_LibraryKit_select(){
        var filters = {
            'runType': "{{helper.getRunTypeObject.runType}}",
        };
        var instrumentType = $('#instrumentType').val();
        if (instrumentType){
            filters['seq_instruments'] = instrumentType;
        }
        var chipType = $('#chipType').val();
        if (chips[chipType]){
            filters['chipTypes'] = chipType;
        }
        filter_select_dropdown(libraryKits, filters, "#libraryKitType");
    }

    function update_TemplateKit_select(){
        var filters = {
            'runType': "{{helper.getRunTypeObject.runType}}",
            'samplePrep_instruments': $('input[name="templatekitType"]:checked').val() == "IonChef"? "IC" : "OT"
        };
        var instrumentType = $('#instrumentType').val();
        if (instrumentType){
            filters['seq_instruments'] = instrumentType;
        }
        var chipType = $('#chipType').val();
        if (chips[chipType]){
            filters['chipTypes'] = chipType;
        }
        filter_select_dropdown(templateKits, filters, "#templateKit");
    }

    function update_SequencingKit_select(){
        var filters = {
            'runType': "{{helper.getRunTypeObject.runType}}",
            'samplePrep_instruments': $('input[name="templatekitType"]:checked').val() == "IonChef"? "IC" : "OT"
        };
        var instrumentType = $('#instrumentType').val();
        if (instrumentType){
            filters['seq_instruments'] = instrumentType;
        }
        var chipType = $('#chipType').val();
        if (chips[chipType]){
            filters['chipTypes'] = chipType;
        }
        filter_select_dropdown(sequencingKits, filters, "#sequenceKit");
    }
    
    function update_ChipType_select(){
        var filters = {};
        var instrumentType = $('#instrumentType').val();
        if (instrumentType)
            filters = {'seq_instrument': instrumentType };
        filter_select_dropdown(chips, filters, "#chipType");
    }
</script>
{% endblock post-raw %}
